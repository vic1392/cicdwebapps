pipeline {
  agent { label 'jenkins-slave' }

  environment {
    IMAGE_NAME        = "yourdockeruser/cicd-webapp"    // change to your registry/repo
    IMAGE_LATEST_TAG  = "${env.IMAGE_NAME}:latest"
    DOCKER_REGISTRY   = "https://index.docker.io/v1/"   // Docker Hub example; remove for ECR/GCR adjustments
    DOCKER_CREDENTIALS_ID = "docker-reg-creds"          // must exist in Jenkins
    EMAIL_RECIPIENTS   = "dev-team@example.com"         // change to your team
    TRIVY_IMAGE        = "aquasec/trivy:0.41.0"         // pinned trivy image
    BUILD_JAR_PATTERN  = "target/*.jar"
  }

  options {
    timestamps()
    buildDiscarder(logRotator(numToKeepStr: '25'))
  }

  stages {
    stage('Checkout') {
      steps {
        // Uses Jenkins' scm config for multibranch / pipeline job
        checkout scm
      }
    }

    stage('Build & Test (Maven)') {
      steps {
        sh 'mvn -B -DskipTests=false clean package'
      }
      post {
        always {
          junit testResults: '**/target/surefire-reports/*.xml', allowEmptyResults: true
        }
      }
    }

    stage('Archive Artifact') {
      steps {
        archiveArtifacts artifacts: "${env.BUILD_JAR_PATTERN}", onlyIfSuccessful: true
      }
    }

    stage('Build Docker Image') {
      steps {
        script {
          def imageTag = "${env.IMAGE_NAME}:${env.BUILD_NUMBER}"
          sh "docker build -t ${imageTag} ."
          sh "docker tag ${imageTag} ${env.IMAGE_LATEST_TAG}"
          env.BUILT_IMAGE = imageTag
        }
      }
    }

    stage('Trivy Image Scan') {
      steps {
        script {
          // Requires agent to have docker access to run scanner and scan local images
          sh """
            docker run --rm -v /var/run/docker.sock:/var/run/docker.sock ${env.TRIVY_IMAGE} \
              image --exit-code 1 --severity HIGH,CRITICAL ${env.BUILT_IMAGE} || true
          """
          // We run with || true above so we can capture output and still attach it.
          // Then fail explicitly if policy requires it:
          script {
            def rc = sh(returnStatus: true, script: "docker run --rm -v /var/run/docker.sock:/var/run/docker.sock ${env.TRIVY_IMAGE} image --exit-code 1 --severity HIGH,CRITICAL ${env.BUILT_IMAGE}")
            if (rc != 0) {
              error("Trivy found HIGH/CRITICAL vulnerabilities - failing build per policy.")
            }
          }
        }
      }
    }

    stage('Push Image to Registry') {
      steps {
        script {
          withCredentials([usernamePassword(credentialsId: env.DOCKER_CREDENTIALS_ID, usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
            // Login (Docker Hub example)
            sh "docker login -u $DOCKER_USER -p $DOCKER_PASS ${env.DOCKER_REGISTRY.replace('https://','')}"
            sh "docker push ${env.BUILT_IMAGE}"
            sh "docker push ${env.IMAGE_LATEST_TAG}"
          }
        }
      }
    }
  }

  post {
    success {
      emailext (
        subject: "SUCCESS: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
        to: "vicky13921392@gmail.com"
        body: """Build SUCCESS
Job: ${env.JOB_NAME}
Build: ${env.BUILD_NUMBER}
Image: ${env.BUILT_IMAGE}
URL: ${env.BUILD_URL}
"""
      )
    }
    failure {
      emailext (
        subject: "FAILURE: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
        to: "vicky13921392@gmail.com"
        body: """Build FAILED
Job: ${env.JOB_NAME}
Build: ${env.BUILD_NUMBER}
URL: ${env.BUILD_URL}
See console for details.
"""
      )
    }
    always {
      cleanWs()
    }
  }
}
